function Config(){this.data={output_directory:"output",dir:"data",file:"manifest.json",gzipped:!1},this.mobileBreakpoint=600,this.isTouchDevice="ontouchstart"in document.documentElement;var t=Math.min(2048,webgl.limits.textureSize),e=Math.min(8192,webgl.limits.textureSize);this.size={cell:32,lodCell:128,atlas:t,texture:this.isTouchDevice?t:webgl.limits.textureSize,lodTexture:this.isTouchDevice?t:e,points:{min:0,max:0,initial:0,grid:0,scatter:0,date:0}},this.transitions={duration:2,delay:0,ease:{value:1,ease:Power1.easeOut}},this.pickerMaxZ=.4,this.atlasesPerTex=(this.size.texture/this.size.atlas)**2,this.isLocalhost=window.location.hostname.includes("localhost")||window.location.hostname.includes("127.0.0.1")||window.location.hostname.includes("0.0.0.0")||window.location.hostname.includes("[::]"),this.setIsNarrowDevice()}function Data(){this.atlasCount=null,this.textureCount=null,this.layouts=[],this.cells=[],this.textures=[],this.textureProgress={},this.loadedTextures=0,this.boundingBox={x:{min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY},y:{min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}},world.getHeightMap(this.load.bind(this))}function Texture(t){this.idx=t.idx,this.atlases=[],this.atlasProgress={},this.loadedAtlases=0,this.onProgress=t.onProgress,this.onLoad=t.onLoad,this.canvas=null,this.ctx=null,this.load()}function getAtlasOffset(t){var e=config.size.atlas,i=config.size.texture;return{x:t*e%i,y:Math.floor(t*e/i)*e%i}}function Atlas(t){this.idx=t.idx,this.progress=0,this.onProgress=t.onProgress,this.onLoad=t.onLoad,this.image=null,this.url=getPath(data.json.atlas_dir+"/atlas-"+this.idx+".jpg"),this.load()}function Cell(t){this.idx=t.idx,this.texIdx=this.getIndexOfTexture(),this.gridCoords={},this.labelColor=[255,0,0],this.x=t.x,this.y=t.y,this.z=t.z||this.getZ(t.x,t.y),this.tx=this.x,this.ty=this.y,this.tz=this.z,this.dx=t.dx,this.dy=t.dy,this.w=t.w,this.h=t.h,this.updateParentBoundingBox()}function Layout(){this.jitterElem=null,this.selected=null,this.options=[],this.elems={input:document.querySelector("#jitter-input"),jitter:document.querySelector("#jitter-container"),icons:document.querySelector("#layout-icons"),layoutCategorical:document.querySelector("#layout-categorical"),layoutDate:document.querySelector("#layout-date"),layoutGeographic:document.querySelector("#layout-geographic"),minDistInput:document.querySelector("#min-dist-range-input"),nNeighborsInput:document.querySelector("#n-neighbors-range-input"),minDistInputContainer:document.querySelector("#min-dist-range-input-container"),nNeighborsInputContainer:document.querySelector("#n-neighbors-range-input-container"),layoutSelect:document.querySelector("#layout-select")}}function World(){this.canvas=document.querySelector("#pixplot-canvas"),this.scene=this.getScene(),this.camera=this.getCamera(),this.renderer=this.getRenderer(),this.controls=this.getControls(),this.stats=this.getStats(),this.color=new THREE.Color,this.defaultLabelColor=new THREE.Color(65280),this.clock=new THREE.Clock,this.center={},this.group={},this.state={flying:!1,transitioning:!1,displayed:!1,mode:"pan",togglingMode:!1},this.elems={pointSize:document.querySelector("#pointsize-range-input"),borderWidth:document.querySelector("#border-width-range-input"),selectTooltip:document.querySelector("#select-tooltip"),selectTooltipButton:document.querySelector("#select-tooltip-button"),mobileInteractions:document.querySelector("#mobile-interaction-guide")},this.addEventListeners()}function Legend(){this.elems={legendContainer:document.querySelector("#legend-container")}}function Lasso(){this.clock=new THREE.Clock,this.time=0,this.points=[],this.enabled=!1,this.capturing=!1,this.frozen=!1,this.mesh=null,this.downloadFiletype="csv",this.selected={},this.displayed=!1,this.mousedownCoords={},this.elems={viewSelectedContainer:document.querySelector("#view-selected-container"),viewSelected:document.querySelector("#view-selected"),selectedImagesCount:document.querySelector("#selected-images-count"),countTarget:document.querySelector("#count-target"),xIcon:document.querySelector("#selected-images-x"),modalTarget:document.querySelector("#selected-images-target"),modalContainer:document.querySelector("#selected-images-modal"),modalTemplate:document.querySelector("#selected-images-template"),filetypeButtons:document.querySelectorAll(".filetype"),downloadLink:document.querySelector("#download-link"),downloadInput:document.querySelector("#download-filename")},this.addMouseEventListeners(),this.addModalEventListeners()}function ConvexHullGrahamScan(){this.anchorPoint=undefined,this.reverse=!1,this.points=[]}function Picker(){this.scene=new THREE.Scene,this.scene.background=new THREE.Color(0),this.mouseDown=new THREE.Vector2,this.tex=this.getTexture()}function Dates(){}function Text(){}function Modal(){this.cellIdx=null,this.cellIndices=[],this.addEventListeners(),this.state={displayed:!1}}function LOD(){var t=1;this.tex=this.getCanvas(config.size.lodTexture),this.cell=this.getCanvas(config.size.lodCell),this.cellIdxToImage={},this.grid={},this.minZ=.8,this.initialRadius=t,this.state={openCoords:this.getAllTexCoords(),camPos:{x:null,y:null},neighborsRequested:0,gridPosToCoords:{},cellIdxToCoords:{},cellsToActivate:[],fetchQueue:[],radius:t,run:!0}}function Labels(){this.idToLabel={},this.labelToId={},this.filenameLabel={},this.userLabelUpdates={},this.labelColors=[[0,0,0],[1,1,1],[1,0,0],[0,1,0],[0,0,1],[.5,.5,.5],[.5,.5,0]],this.elems={legendContainer:document.querySelector("#legend-container"),downloadIcon:document.querySelector("#download-updates-icon")},this.elems.downloadIcon.addEventListener("click",this.downloadUpdates.bind(this))}function Filters(){this.filters=[],self.values=[]}function Filter(t){if(this.values=t.filter_values||[],!(this.values.length<=1)){this.selected=null,this.name=t.filter_name||"",this.desktopSelect=document.createElement("div"),this.desktopSelect.addEventListener("mouseenter",this.show.bind(this)),this.desktopSelect.addEventListener("mouseleave",this.hide.bind(this)),this.desktopSelect.className="filter",(l=document.createElement("div")).className="settings-label filter-label",l.textContent="Category",this.desktopSelect.appendChild(l),this.mobileSelect=document.createElement("select");var e=document.createElement("div");e.className="filter-options";for(var i=0;i<this.values.length;i++){var o=document.createElement("div");o.setAttribute("data-label",this.values[i]),o.addEventListener("click",this.onChange.bind(this,!0)),o.className="filter-option no-highlight";var s=imageLabels.labelToId[this.values[i].replaceAll("__"," ")],n=imageLabels.labelColors[s],a="#"+(255*n[0]).toString(16).padStart(2,"0")+(255*n[1]).toString(16).padStart(2,"0")+(255*n[2]).toString(16).padStart(2,"0");o.style="accent-color: "+a;var r=document.createElement("input"),l=document.createElement("div");r.setAttribute("type","checkbox"),l.textContent=this.values[i].replace(/__/g," "),o.appendChild(r),o.appendChild(l),e.appendChild(o);var d=document.createElement("option");d.value=this.values[i],d.text=this.values[i].replace(/__/g," "),d.text.length>22&&(d.text=d.text.substring(0,22)+"..."),d.setAttribute("data-label",this.values[i]),this.mobileSelect.appendChild(d)}this.desktopSelect.appendChild(e),this.mobileSelect.addEventListener("change",this.onChange.bind(this,!1)),document.querySelector("#filters-desktop").appendChild(this.desktopSelect),document.querySelector("#filters-mobile").appendChild(this.mobileSelect),document.querySelector("#pixplot-canvas").addEventListener("click",this.hide.bind(this))}}function Settings(){this.elems={tray:document.querySelector("#header-controls-bottom"),icon:document.querySelector("#settings-icon")},this.state={open:!1},this.elems.icon.addEventListener("click",this.toggleOpen.bind(this))}function Search(){}function Hotspots(){this.json={},this.mesh=null,this.edited=!1,this.nUserClusters=0,this.elems={createHotspot:document.querySelector("#create-hotspot"),saveHotspots:document.querySelector("#save-hotspots"),navInner:document.querySelector("#nav-inner"),template:document.querySelector("#hotspot-template"),hotspots:document.querySelector("#hotspots"),nav:document.querySelector("nav"),tooltip:document.querySelector("#hotspots-tooltip"),clearTooltip:document.querySelector("#hotspots-tooltip-button")},this.addEventListeners()}function Globe(){this.globeGeometry=new THREE.Geometry,this.globeMesh=null,this.featureGeometry=new THREE.Geometry,this.featureMesh=null}function Webgl(){this.gl=this.getGl(),this.limits=this.getLimits()}function Keyboard(){this.pressed={},window.addEventListener("keydown",function(t){this.pressed[t.keyCode]=!0}.bind(this)),window.addEventListener("keyup",function(t){this.pressed[t.keyCode]=!1}.bind(this))}function Tooltip(){this.elem=document.querySelector("#tooltip"),this.targets=[{elem:document.querySelector("#layout-alphabetic"),text:"Order images alphabetically by filename"},{elem:document.querySelector("#layout-umap"),text:"Cluster images via UMAP dimensionality reduction"},{elem:document.querySelector("#layout-date"),text:"Order images by date"},{elem:document.querySelector("#layout-categorical"),text:"Arrange images into metadata groups"},{elem:document.querySelector("#layout-geographic"),text:"Arrange images using lat/lng coordinates"},{elem:document.querySelector("#settings-icon"),text:"Configure plot settings"},{elem:document.querySelector("#download-updates-icon"),text:"Download label updates"}],this.targets.forEach(function(t){t.elem.addEventListener("mouseenter",function(e){if(!e.target.classList.contains("no-tooltip")){var i=t.elem.getBoundingClientRect();this.elem.textContent=t.text,this.elem.style.position="absolute",this.elem.style.left=i.left+t.elem.clientWidth-this.elem.clientWidth+9+"px",this.elem.style.top=i.top+t.elem.clientHeight+16+"px"}}.bind(this)),t.elem.addEventListener("mouseleave",this.hide.bind(this))}.bind(this))}function Welcome(){this.progressElem=document.querySelector("#progress"),this.loaderTextElem=document.querySelector("#loader-text"),this.loaderSceneElem=document.querySelector("#loader-scene"),this.buttonElem=document.querySelector("#enter-button"),this.buttonElem.addEventListener("click",this.onButtonClick.bind(this))}function Swipes(t){this.xDown=null,this.yDown=null,document.addEventListener("touchstart",function(t){this.xDown=t.touches[0].clientX,this.yDown=t.touches[0].clientY},!1),document.addEventListener("touchmove",function(e){if(this.xDown&&this.yDown){var i=e.touches[0].clientX,o=e.touches[0].clientY,s=this.xDown-i,n=this.yDown-o;t.onSwipeUp||t.onSwipeDown?Math.abs(s)>Math.abs(n)?s>0?t.onSwipeRight&&t.onSwipeRight():t.onSwipeLeft&&t.onSwipeLeft():n>0?t.onSwipeUp&&t.onSwipeUp():t.onSwipeDown&&t.onSwipeDown():s>0?t.onSwipeRight&&t.onSwipeRight():t.onSwipeLeft&&t.onSwipeLeft(),this.xDown=null,this.yDown=null}},!1)}function get(t,e,i){e=e||function(){},i=i||function(){};var o=new XMLHttpRequest;o.overrideMimeType("text/plain; charset=x-user-defined"),o.onreadystatechange=function(){if(o.readyState==XMLHttpRequest.DONE)if(200===o.status){var s=o.responseText;".gz"==t.substring(t.length-3)&&(s=gunzip(s),t=t.substring(0,t.length-3)),t.includes("id_to_label")&&console.info(s),".json"==t.substring(t.length-5)?e(JSON.parse(s)):e(s)}else i(o)},o.open("GET",t,!0),o.send()}function gunzip(t){for(var e=[],i=0;i<t.length;i++)e.push(255&t.charCodeAt(i));var o=new Zlib.Gunzip(e).decompress(),s="";for(i=0;i<o.length;i++)s+=String.fromCharCode(o[i]);return s}function downloadFile(t,e){var i=e.split("."),o="json"==i[i.length-1]?new Blob([JSON.stringify(t)],{type:"octet/stream"}):new Blob([Papa.unparse(t)],{type:"text/plain"}),s=document.createElement("a");document.body.appendChild(s),s.download=e,s.href=window.URL.createObjectURL(o),s.click(),s.parentNode.removeChild(s)}function downloadBlob(t,e){var i=document.createElement("a");document.body.appendChild(i),i.download=e,i.href=window.URL.createObjectURL(t),i.click(),i.parentNode.removeChild(i)}function imageToDataUrl(t,e,i){i=i||"image/png";var o=new Image;o.crossOrigin="Anonymous",o.onload=function(){var o=document.createElement("CANVAS"),s=o.getContext("2d");o.height=this.naturalHeight,o.width=this.naturalWidth,s.drawImage(this,0,0);var n=o.toDataURL(i);e({src:t,dataUrl:n})},o.src=t,(o.complete||o.complete===undefined)&&(o.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",o.src=t)}function AttractMode(){this.delays={initialize:6e4,layoutChange:4e3,clusterZoom:4e3,beforeLightbox:4e3,betweenLightbox:3e3,afterLightbox:2e3},this.disabled=!window.location.href.includes("demo"),this.active=!1,this.hotspot=null,this.viewIndex=-1,this.eventIndex=-1,this.nImages=4,this.timeout=null,this.activeTimer=this.disabled?null:setTimeout(this.setActive.bind(this,!0),this.delays.initialize),["click","mousemove","keydown","visibilitychange"].forEach(function(t){window.addEventListener(t,this.resetActiveTimer.bind(this))}.bind(this))}function getMinCellZ(){for(var t=Number.POSITIVE_INFINITY,e=0;e<data.cells.length;e++)t=Math.min(data.cells[e].z,t);return t}function getElem(t,e){e=e||{};var i=document.createElement(t);return Object.keys(e).forEach(function(t){i[t]=e[t]}),i}function choose(t){return t[Math.floor(Math.random()*t.length)]}function valueSum(t){return Object.keys(t).reduce(function(e,i){return e+=t[i]},0)}function getNested(t,e,i){var o=e.reduce(function(t,e){return t[e]?t[e]:{}},t);return o.length?o:i}function getCanvasSize(){var t=document.querySelector("#pixplot-canvas");return{w:t.clientWidth,h:t.clientHeight}}function getPath(t){var e=window.location.origin;return e+=window.location.pathname.replace("index.html",""),e+=t.replace("\\","/").replace(config.data.output_directory+"/","")}function trimFilenameSuffix(t){var e=t.split(".")[t.split(".").length-1],i=t.split("-");return i.slice(0,i.length-1).join("-")+"."+e}function scale(t){for(var e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,o={min:e,max:i},s={min:e,max:i},n={min:e,max:i},a=0;a<t.length;a++){var r=t[a][0],l=t[a][1],d=t[a][2]||0;r<o.min&&(o.min=r),r>o.max&&(o.max=r),l<s.min&&(s.min=l),l>s.max&&(s.max=l),d<n.min&&(n.min=d),d>n.max&&(n.max=d)}var h=[];for(a=0;a<t.length;a++){var c=(t[a][0]-o.min)/(o.max-o.min)*2-1,u=(t[a][1]-s.min)/(s.max-s.min)*2-1,p=(t[a][2]-n.min)/(n.max-n.min)*2-1||null;3==t[a].length?h.push([c,u,p]):h.push([c,u])}return h}function arrayify(t){for(var e=Object.keys(t),i=[],o=0;o<e.length;o++)i.push(t[e[o]]);return i}function magnitude(t){var e=0;if(Array.isArray(t)){for(var i=0;i<t.length;i++)e+=t[i]**2;return e**.5}if("object"==typeof t)return magnitude(arrayify(t));throw Error("magnitude requires an array or object")}function dotProduct(t,e){if("object"!=typeof t||Array.isArray(t)||(t=arrayify(t)),"object"!=typeof e||Array.isArray(e)||(e=arrayify(e)),t.length!==e.length)throw Error("dotProduct requires vecs of same length");for(var i=0,o=0;o<t.length;o++)i+=t[o]*e[o];return i}function rad2deg(t){return t*(180/Math.PI)}function theta(t,e){var i=dotProduct(t,e),o=magnitude(t)*magnitude(e),s=0==o?0:Math.acos(i/o);return s?rad2deg(s):0}function getCentroid(t){t||(t=this.getHull());for(var e={x:0,y:0},i=0;i<t.length;i++)e.x+=t[i].x,e.y+=t[i].y;return{x:e.x/t.length,y:e.y/t.length}}function getCumulativeLengths(t){for(var e=[],i=0,o=0;o<t.length;o++)o>0&&(i+=t[o].distanceTo(t[o-1])),e[o]=i;return e}function pointInPolygon(t,e){for(var i=t[0],o=t[1],s=!1,n=0,a=e.length-1;n<e.length;a=n++){var r=e[n][0],l=e[n][1],d=e[a][0],h=e[a][1];l>o!=h>o&&i<(d-r)*(o-l)/(h-l)+r&&(s=!s)}return s}function getEventClientCoords(t){return{x:t.touches&&t.touches[0]&&"clientX"in t.touches[0]?t.touches[0].clientX:t.changedTouches&&t.changedTouches[0]&&"clientX"in t.changedTouches[0]?t.changedTouches[0].clientX:t.clientX?t.clientX:t.pageX,y:t.touches&&t.touches[0]&&"clientY"in t.touches[0]?t.touches[0].clientY:t.changedTouches&&t.changedTouches[0]&&"clientY"in t.changedTouches[0]?t.changedTouches[0].clientY:t.clientY?t.clientY:t.pageY}}function getEventWorldCoords(t){var e=t.target.getBoundingClientRect(),i=getEventClientCoords(t);return screenToWorldCoords({x:i.x-e.left,y:i.y-e.top})}function screenToWorldCoords(t){var e=new THREE.Vector3,i=world.camera,o=(new THREE.Vector2,getCanvasSize()),s=t.x/o.w*2-1,n=-t.y/o.h*2+1;e.set(s,n,.5),e.unproject(i);var a=e.sub(i.position).normalize(),r=-i.position.z/a.z,l=a.multiplyScalar(r);return i.position.clone().add(l)}function worldToScreenCoords(t){var e=getCanvasSize(),i=e.w/2,o=e.h/2,s=new THREE.Vector3(t.x,t.y,t.z||0);s.project(world.camera),s.x=s.x*i+i,s.y=-s.y*o+o;var n=world.canvas.getBoundingClientRect();return{x:s.x+n.left,y:s.y+n.top}}Config.prototype.setIsNarrowDevice=function(){this.isNarrowDevice=window.innerWidth<this.mobileBreakpoint},Data.prototype.load=function(){get(getPath(config.data.dir+"/"+config.data.file),function(t){config.data.output_directory=t.output_directory,get(getPath(t.imagelist),function(e){this.parseManifest(Object.assign({},t,e))}.bind(this))}.bind(this),function(){config.data.gzipped?console.warn("ERROR: could not load manifest.json"):(config.data.gzipped=!0,config.data.file=config.data.file+".gz",this.load())}.bind(this))},Data.prototype.parseManifest=function(t){this.json=t,config.size.cell=t.config.sizes.cell,config.size.atlas=t.config.sizes.atlas,config.size.lodCell=t.config.sizes.lod,config.size.points=t.point_sizes,world.elems.pointSize.min=0,world.elems.pointSize.max=config.size.points.max,world.elems.pointSize.value=config.size.points.initial/window.devicePixelRatio,this.atlasCount=t.atlas.count,this.textureCount=Math.ceil(t.atlas.count/config.atlasesPerTex),this.layouts=t.layouts,this.hotspots=new Hotspots,layout.init(Object.keys(this.layouts).filter(function(t){return this.layouts[t]}.bind(this))),t.metadata&&imageLabels.loadLabels(),t.metadata&&filters.loadFilters(),t.layouts.geographic&&globe.load();for(var e=0;e<this.textureCount;e++)this.textures.push(new Texture({idx:e,onProgress:this.onTextureProgress.bind(this),onLoad:this.onTextureLoad.bind(this)}));layout.getLayoutPath.bind(layout),get(getPath(layout.getLayoutPath()),function(t){this.addCells(t),this.hotspots.initialize()}.bind(this))},Data.prototype.onTextureProgress=function(t,e){this.textureProgress[t]=e/this.textures[t].getAtlasCount(),welcome.updateProgress()},Data.prototype.onTextureLoad=function(){this.loadedTextures+=1,welcome.updateProgress()},Data.prototype.addCells=function(t){for(var e={idx:0,textures:[],vertices:0},i=0,o=0;o<this.json.cell_sizes.length;o++)for(var s=0;s<this.json.cell_sizes[o].length;s++){e.vertices++;Math.floor(o/config.atlasesPerTex);var n=t[i],a=this.json.atlas.positions[o][s],r=getAtlasOffset(o),l=this.json.cell_sizes[o][s];this.cells.push(new Cell({idx:i,w:l[0],h:l[1],x:n[0],y:n[1],z:n[2]||null,dx:a[0]+r.x,dy:a[1]+r.y})),i++}lod.indexCells()},Texture.prototype.setCanvas=function(){this.canvas=getElem("canvas",{width:config.size.texture,height:config.size.texture,id:"texture-"+this.idx}),this.ctx=this.canvas.getContext("2d")},Texture.prototype.load=function(){this.setCanvas();for(var t=0;t<this.getAtlasCount();t++)this.atlases.push(new Atlas({idx:config.atlasesPerTex*this.idx+t,onProgress:this.onAtlasProgress.bind(this),onLoad:this.onAtlasLoad.bind(this)}))},Texture.prototype.getAtlasCount=function(){var t=data.atlasCount/config.atlasesPerTex>this.idx+1?config.atlasesPerTex:data.atlasCount%config.atlasesPerTex;return t||1},Texture.prototype.onAtlasProgress=function(t,e){this.atlasProgress[t]=e;var i=valueSum(this.atlasProgress);this.onProgress(this.idx,i)},Texture.prototype.onAtlasLoad=function(t){config.size.atlas,config.size.texture;var e=getAtlasOffset(t.idx%config.atlasesPerTex),i=config.size.atlas,o=config.size.atlas;this.ctx.drawImage(t.image,e.x,e.y,i,o),++this.loadedAtlases==this.getAtlasCount()&&this.onLoad(this.idx)},Atlas.prototype.load=function(){this.image=new Image,this.image.onload=function(){this.onLoad(this)}.bind(this);var t=new XMLHttpRequest;t.onprogress=function(t){var e=parseInt(t.loaded/t.total*100);this.onProgress(this.idx,e)}.bind(this),t.onload=function(t){this.image.src=window.URL.createObjectURL(t.target.response)}.bind(this),t.open("GET",this.url,!0),t.responseType="blob",t.send()},Cell.prototype.getZ=function(t,e){return world.getHeightAt(t,e)||0},Cell.prototype.updateParentBoundingBox=function(){var t=data.boundingBox;["x","y"].forEach(function(e){t[e].max=Math.max(t[e].max,this[e]),t[e].min=Math.min(t[e].min,this[e])}.bind(this))},Cell.prototype.getIndexOfAtlas=function(){for(var t=0,e=0;e<data.json.atlas.positions.length;e++)if((t+=data.json.atlas.positions[e].length)>this.idx)return e;return e},Cell.prototype.getIndexInAtlas=function(){for(var t=this.getIndexOfAtlas(),e=0,i=0;i<t;i++)e+=data.json.atlas.positions[i].length;return this.idx-e},Cell.prototype.getIndexOfTexture=function(){return Math.floor(this.getIndexOfAtlas()/config.atlasesPerTex)},Cell.prototype.getIndexInTexture=function(){for(var t=0,e=0;e<this.getIndexOfAtlas();e++)e%config.atlaesPerTex==0&&(t=0),t+=data.json.atlas.positions[t].length;return t+this.getIndexInAtlas()},Cell.prototype.getIndexOfDrawCall=function(){return Math.floor(this.idx/webgl.limits.indexedElements)},Cell.prototype.getIndexInDrawCall=function(){return this.idx%webgl.limits.indexedElements},Cell.prototype.activate=function(){this.dx=lod.state.cellIdxToCoords[this.idx].x,this.dy=lod.state.cellIdxToCoords[this.idx].y,this.texIdx=-1,["textureIndex","offset"].forEach(this.setBuffer.bind(this))},Cell.prototype.deactivate=function(){var t=this.getIndexOfAtlas(),e=this.getIndexInAtlas(),i=getAtlasOffset(t);d=data.json.atlas.positions[t][e],this.dx=d[0]+i.x,this.dy=d[1]+i.y,this.texIdx=this.getIndexOfTexture(),["textureIndex","offset"].forEach(this.setBuffer.bind(this))},Cell.prototype.setBuffer=function(t){var e=world.group.children[this.getIndexOfDrawCall()].geometry.attributes,i=this.getIndexInDrawCall();switch(t){case"textureIndex":return void(e.textureIndex.array[i]=this.texIdx);case"offset":-1==this.texIdx?config.size.lodTexture:config.size.texture;return e.offset.array[2*i]=this.dx,void(e.offset.array[2*i+1]=this.dy);case"translation":return e.translation.array[3*i]=this.x,e.translation.array[3*i+1]=this.y,void(e.translation.array[3*i+2]=this.z);case"targetTranslation":return e.targetTranslation.array[3*i]=this.tx,e.targetTranslation.array[3*i+1]=this.ty,void(e.targetTranslation.array[3*i+2]=this.tz)}},Layout.prototype.init=function(t){this.options=t,this.selected=data.json.initial_layout||Object.keys(t)[0],this.initializeMobileLayoutOptions(),this.initializeUmapInputs(),this.showHideIcons(),this.showHideJitter(),this.showHideUmapInputs(),this.addEventListeners(),this.selectActiveIcon()},Layout.prototype.initializeMobileLayoutOptions=function(){this.options.forEach(function(t){if(data.layouts[t]){var e=document.createElement("option");e.value=t,e.textContent=t,this.elems.layoutSelect.appendChild(e)}}.bind(this))},Layout.prototype.showHideIcons=function(){for(var t=config.isTouchDevice||config.isNarrowDevice?"none":"inline-block",e=this.elems.icons.querySelectorAll("img"),i=0;i<e.length;i++){var o=e[i].getAttribute("id").replace("layout-","");e[i].classList.contains("conditional")?(!o in data.layouts||!data.layouts[o])&&(e[i].style.display="none"):e[i].style.display=t}},Layout.prototype.initializeUmapInputs=function(){var t=this.getNNeighborsOptions(),e=this.getMinDistOptions();this.elems.nNeighborsInput.setAttribute("max",t.length-1),this.elems.minDistInput.setAttribute("max",e.length-1),this.elems.nNeighborsInput.addEventListener("change",function(){this.set("umap",!0)}.bind(this)),this.elems.minDistInput.addEventListener("change",function(){this.set("umap",!0)}.bind(this))},Layout.prototype.showHideUmapInputs=function(){"umap"!==this.selected?(this.elems.minDistInputContainer.style.display="none",this.elems.nNeighborsInputContainer.style.display="none"):(this.elems.nNeighborsInputContainer.style.display=this.getNNeighborsOptions().length>1?"inline-block":"none",this.elems.minDistInputContainer.style.display=this.getMinDistOptions().length>1?"inline-block":"none")},Layout.prototype.getNNeighborsOptions=function(){var t=data.layouts.umap.variants.reduce(function(t,e){return t[e.n_neighbors]=!0,t},{});return(t=Object.keys(t)).sort(function(t,e){return e-t}),t},Layout.prototype.getMinDistOptions=function(){var t=data.layouts.umap.variants.reduce(function(t,e){return t[e.min_dist]=!0,t},{});return(t=Object.keys(t)).sort(function(t,e){return e-t}),t},Layout.prototype.getSelectedNNeighbors=function(){return this.getNNeighborsOptions()[parseInt(this.elems.nNeighborsInput.value)]},Layout.prototype.getSelectedMinDist=function(){return this.getMinDistOptions()[parseInt(this.elems.minDistInput.value)]},Layout.prototype.selectActiveIcon=function(){for(var t=this.elems.icons.querySelectorAll(".layout-icon"),e=0;e<t.length;e++)t[e].classList.remove("active");try{document.querySelector("#layout-"+this.selected).classList.add("active")}catch(i){console.warn("The requested layout has no icon:",this.selected)}this.elems.layoutSelect.selected=this.selected},Layout.prototype.addEventListeners=function(){this.elems.icons.addEventListener("click",function(t){t.target&&t.target.id&&"icons"!=t.target.id&&this.set(t.target.id.replace("layout-",""),!0)}.bind(this)),this.elems.jitter.addEventListener("click",function(t){"INPUT"!=t.target.tagName&&(this.elems.input.checked?(this.elems.input.checked=!1,this.elems.jitter.classList.remove("visible")):(this.elems.input.checked=!0,this.elems.jitter.classList.add("visible"))),this.set(this.selected,!1)}.bind(this)),this.elems.layoutSelect.addEventListener("change",function(t){this.set(t.target.value)}.bind(this)),window.addEventListener("resize",function(){this.showHideIcons()}.bind(this))},Layout.prototype.set=function(t,e){if("settings-icon"!==t&&"download-updates-icon"!=t&&!world.state.transitioning)if(t in data.json.layouts&&data.json.layouts[t]){world.state.transitioning=!0,this.selected=t,world.setMode("pan"),this.selectActiveIcon(),this.setPointScalar(),this.setText(),this.showHideContext(),this.showHideJitter(),this.showHideUmapInputs();var i=world.recenterCamera(e);data.hotspots.setCreateHotspotVisibility(!1),setTimeout(function(){get(getPath(this.getLayoutPath()),function(t){lod.clear();for(var e=0;e<data.cells.length;e++)data.cells[e].tx=t[e][0],data.cells[e].ty=t[e][1],data.cells[e].tz=t[e][2]||data.cells[e].getZ(t[e][0],t[e][1]),data.cells[e].setBuffer("targetTranslation");var i=[];for(e=0;e<world.group.children.length;e++)world.group.children[e].geometry.attributes.targetTranslation.needsUpdate=!0,i.push(world.group.children[e].material.uniforms.transitionPercent);TweenMax.to(i,config.transitions.duration,config.transitions.ease),setTimeout(this.onTransitionComplete.bind(this),1e3*config.transitions.duration)}.bind(this))}.bind(this),i)}else console.warn("The requested layout is not in data.json.layouts")},Layout.prototype.getLayoutPath=function(){var t=this.getJittered()?"jittered":"layout";return"umap"!==this.selected?data.layouts[this.selected][t]:data.layouts[this.selected].variants.filter(function(t){return t.n_neighbors.toString()===this.getSelectedNNeighbors()&&t.min_dist.toString()===this.getSelectedMinDist()}.bind(this))[0][t]},Layout.prototype.setPointScalar=function(){var t=!1,e=this.selected;if("tsne"!=e&&"umap"!=e||(t=config.size.points.scatter),"alphabetic"!=e&&"grid"!=e||(t=config.size.points.grid),"categorical"==e&&(t=config.size.points.categorical),"geographic"==e&&(t=config.size.points.geographic),"date"==e&&(t=config.size.points.date),t){world.elems.pointSize.value=t/window.devicePixelRatio;var i=world.getPointScale();world.setUniform("targetScale",i)}},Layout.prototype.showHideJitter=function(){this.getJitterable()?world.state.transitioning?this.elems.jitter.classList.add("visible","disabled"):this.elems.jitter.classList.add("visible"):this.elems.jitter.classList.remove("visible")},Layout.prototype.getJittered=function(){return this.getJitterable()&&this.elems.input.checked},Layout.prototype.getJitterable=function(){return"umap"===this.selected||"jittered"in data.layouts[this.selected]},Layout.prototype.showHideContext=function(){"geographic"==this.selected?globe.show():globe.hide()},Layout.prototype.setText=function(){if(text.mesh){var t=data.json.layouts[this.selected].labels;t&&text.mesh?(get(getPath(t),text.formatText.bind(text)),text.mesh.material.uniforms.render.value=1):text.mesh.material.uniforms.render.value=0}},Layout.prototype.onTransitionComplete=function(){this.elems.jitter.classList.remove("disabled"),data.cells.forEach(function(t){t.x=t.tx,t.y=t.ty,t.z=t.tz,t.setBuffer("translation")});for(var t=0;t<world.group.children.length;t++)world.group.children[t].geometry.attributes.translation.needsUpdate=!0,world.group.children[t].material.uniforms.transitionPercent={type:"f",value:0};world.state.transitioning=!1,world.setScaleUniforms(),lod.indexCells()},World.prototype.getScene=function(){var t=new THREE.Scene;return t.background=new THREE.Color(6052956),t},World.prototype.getCamera=function(){var t=getCanvasSize(),e=t.w/t.h;return new THREE.PerspectiveCamera(75,e,.001,10)},World.prototype.getRenderer=function(){var t=new THREE.WebGLRenderer({antialias:!0,canvas:this.canvas});return t.autoClear=!1,t.toneMapping=THREE.ReinhardToneMapping,t},World.prototype.getControls=function(){var t;return window.location.href.includes("fly=true")?((t=new THREE.FlyControls(this.camera,this.canvas)).type="fly",t.movementSpeed=.2,t.rollSpeed=Math.PI/20,t):((t=new THREE.TrackballControls(this.camera,this.canvas)).zoomSpeed=.2,t.panSpeed=.4,t.noRotate=!0,t.mouseButtons.LEFT=THREE.MOUSE.PAN,t.mouseButtons.MIDDLE=THREE.MOUSE.ZOOM,t.mouseButtons.RIGHT=THREE.MOUSE.ROTATE,t.maxDistance=3,t.type="trackball",t)},World.prototype.getHeightMap=function(t){var e=new Image;e.crossOrigin="Anonymous",e.onload=function(){var i=document.createElement("canvas"),o=i.getContext("2d");i.width=e.width,i.height=e.height,o.drawImage(e,0,0),this.heightmap=o.getImageData(0,0,e.width,e.height),t()}.bind(this),e.src=this.heightmap||"assets/images/heightmap.jpg"},World.prototype.getHeightAt=function(t,e){t=(t+1)/2,e=(e+1)/2;var i=Math.floor(e*(this.heightmap.height-1)),o=Math.floor(t*(this.heightmap.width-1)),s=i*this.heightmap.width*4+4*o;return this.heightmap.data[s]*(this.heightmapScalar/1e3||0)},World.prototype.addEventListeners=function(){this.addResizeListener(),this.addLostContextListener(),this.addScalarChangeListener(),this.addBorderWidthChangeListener(),this.addTabChangeListeners(),this.addModeChangeListeners()},World.prototype.addResizeListener=function(){window.addEventListener("resize",this.handleResize.bind(this),!1)},World.prototype.handleResize=function(){var t=getCanvasSize(),e=t.w*window.devicePixelRatio,i=t.h*window.devicePixelRatio;this.camera.aspect=e/i,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,i,!1),"trackball"===this.controls.type&&this.controls.handleResize(),picker.tex.setSize(e,i),this.setScaleUniforms(),config.setIsNarrowDevice(),layout.showHideIcons()},World.prototype.setScaleUniforms=function(){if(this.state.displayed){var t=world.getPointScale();world.setUniform("scale",t)}},World.prototype.addScalarChangeListener=function(){this.elems.pointSize.addEventListener("change",this.setScaleUniforms.bind(this)),this.elems.pointSize.addEventListener("input",this.setScaleUniforms.bind(this))},World.prototype.addBorderWidthChangeListener=function(){this.elems.borderWidth.addEventListener("change",this.setBorderWidthUniforms.bind(this)),this.elems.borderWidth.addEventListener("input",this.setBorderWidthUniforms.bind(this))},World.prototype.setBorderWidthUniforms=function(t){world.setUniform("borderWidth",parseFloat(t.target.value))},World.prototype.addTabChangeListeners=function(){window.addEventListener("visibilitychange",function(){this.canvas.width=this.canvas.width+1,setTimeout(function(){this.canvas.width=this.canvas.width-1}.bind(this),50)}.bind(this))},World.prototype.addLostContextListener=function(){this.canvas.addEventListener("webglcontextlost",function(t){t.preventDefault(),window.location.reload()})},World.prototype.addModeChangeListeners=function(){document.querySelector("#pan").addEventListener("click",this.handleModeIconClick.bind(this)),document.querySelector("#select").addEventListener("click",this.handleModeIconClick.bind(this)),document.querySelector("#select").addEventListener("mouseenter",this.showSelectTooltip.bind(this)),document.body.addEventListener("keydown",this.handleKeyDown.bind(this)),document.body.addEventListener("keyup",this.handleKeyUp.bind(this))},World.prototype.setCenter=function(){this.center={x:(data.boundingBox.x.min+data.boundingBox.x.max)/2,
y:(data.boundingBox.y.min+data.boundingBox.y.max)/2}},World.prototype.recenterCamera=function(t){var e=this.getInitialLocation();return this.camera.position.z<e.z&&t?(this.flyTo(e),1e3*config.transitions.duration):0},World.prototype.plotPoints=function(){var t=this.getDrawCallToCells();for(var e in this.group=new THREE.Group,t){var i=t[e],o=this.getGroupAttributes(i),s=new THREE.InstancedBufferGeometry;s.setIndex([0,1,2,2,3,0]),s.setAttribute("position",o.position),s.setAttribute("uv",o.uv),s.setAttribute("translation",o.translation),s.setAttribute("targetTranslation",o.targetTranslation),s.setAttribute("color",o.color),s.setAttribute("width",o.width),s.setAttribute("height",o.height),s.setAttribute("offset",o.offset),s.setAttribute("opacity",o.opacity),s.setAttribute("selected",o.selected),s.setAttribute("clusterSelected",o.clusterSelected),s.setAttribute("textureIndex",o.textureIndex),s.setAttribute("labelBorderColor",o.labelBorderColor),s.setDrawRange(0,i.length);var n=this.getShaderMaterial({firstTex:o.texStartIdx,textures:o.textures,useColor:!1});n.transparent=!0;var a=new THREE.Mesh(s,n);a.frustumCulled=!1,this.group.add(a)}this.scene.add(this.group)},World.prototype.getDrawCallToCells=function(){for(var t={},e=0;e<data.cells.length;e++){var i=data.cells[e],o=i.getIndexOfDrawCall();o in t?t[o].push(i):t[o]=[i]}return t},World.prototype.getGroupAttributes=function(t){for(var e=this.getCellIterators(t.length),i=0;i<t.length;i++){var o=t[i],s=this.color.setHex(t[i].idx+1);e.texIndex[e.texIndexIterator++]=o.texIdx,e.translation[e.translationIterator++]=o.x,e.translation[e.translationIterator++]=o.y,e.translation[e.translationIterator++]=o.z,e.targetTranslation[e.targetTranslationIterator++]=o.tx,e.targetTranslation[e.targetTranslationIterator++]=o.ty,e.targetTranslation[e.targetTranslationIterator++]=o.tz,e.color[e.colorIterator++]=s.r,e.color[e.colorIterator++]=s.g,e.color[e.colorIterator++]=s.b,e.opacity[e.opacityIterator++]=1,e.selected[e.selectedIterator++]=0,e.clusterSelected[e.clusterSelectedIterator++]=0,e.width[e.widthIterator++]=o.w,e.height[e.heightIterator++]=o.h,e.offset[e.offsetIterator++]=o.dx,e.offset[e.offsetIterator++]=o.dy;var n=this.defaultLabelColor;e.labelBorderColor[e.labelBorderColorIterator++]=n.r,e.labelBorderColor[e.labelBorderColorIterator++]=n.g,e.labelBorderColor[e.labelBorderColorIterator++]=n.b}var a=new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0]),r=new Float32Array([0,0,1,0,1,1,0,1]),l=new THREE.BufferAttribute(a,3,!0,1),d=new THREE.BufferAttribute(r,2,!0,1),h=new THREE.InstancedBufferAttribute(e.translation,3,!0,1),c=new THREE.InstancedBufferAttribute(e.targetTranslation,3,!0,1),u=new THREE.InstancedBufferAttribute(e.color,3,!0,1),p=new THREE.InstancedBufferAttribute(e.opacity,1,!0,1),g=new THREE.InstancedBufferAttribute(e.selected,1,!1,1),f=new THREE.InstancedBufferAttribute(e.clusterSelected,1,!1,1),m=new THREE.InstancedBufferAttribute(e.texIndex,1,!1,1),y=new THREE.InstancedBufferAttribute(e.width,1,!1,1),v=new THREE.InstancedBufferAttribute(e.height,1,!1,1),x=new THREE.InstancedBufferAttribute(e.offset,2,!1,1),b=new THREE.InstancedBufferAttribute(e.labelBorderColor,3,!0,1);m.usage=THREE.DynamicDrawUsage,h.usage=THREE.DynamicDrawUsage,c.usage=THREE.DynamicDrawUsage,p.usage=THREE.DynamicDrawUsage,g.usage=THREE.DynamicDrawUsage,f.usage=THREE.DynamicDrawUsage,x.usage=THREE.DynamicDrawUsage,b.usage=THREE.DynamicDrawUsage;var w=this.getTexIndices(t);return{position:l,uv:d,translation:h,targetTranslation:c,color:u,width:y,height:v,offset:x,opacity:p,selected:g,clusterSelected:f,textureIndex:m,textures:this.getTextures({startIdx:w.first,endIdx:w.last}),texStartIdx:w.first,texEndIdx:w.last,labelBorderColor:b}},World.prototype.getCellIterators=function(t){return{translation:new Float32Array(3*t),targetTranslation:new Float32Array(3*t),color:new Float32Array(3*t),width:new Uint8Array(t),height:new Uint8Array(t),offset:new Uint16Array(2*t),opacity:new Float32Array(t),selected:new Uint8Array(t),clusterSelected:new Uint8Array(t),texIndex:new Int8Array(t),translationIterator:0,targetTranslationIterator:0,colorIterator:0,widthIterator:0,heightIterator:0,offsetIterator:0,opacityIterator:0,selectedIterator:0,clusterSelectedIterator:0,texIndexIterator:0,labelBorderColor:new Float32Array(3*t),labelBorderColorIterator:0}},World.prototype.getTexIndices=function(t){for(var e=0;-1==t[e].texIdx;)e++;for(var i=t.length-1;-1==t[i].texIdx;)i--;return{first:t[e].texIdx,last:t[i].texIdx}},World.prototype.getTextures=function(t){for(var e=[],i=t.startIdx;i<=t.endIdx;i++){var o=this.getTexture(data.textures[i].canvas);e.push(o)}return e},World.prototype.getTexture=function(t){var e=new THREE.Texture(t);return e.needsUpdate=!0,e.flipY=!1,e.generateMipmaps=!1,e.magFilter=THREE.LinearFilter,e.minFilter=THREE.LinearFilter,e.wrapS=THREE.ClampToEdgeWrapping,e.wrapT=THREE.ClampToEdgeWrapping,e},World.prototype.getPointScale=function(){var t=parseFloat(this.elems.pointSize.value),e=getCanvasSize();return t*window.devicePixelRatio*e.h},World.prototype.getShaderMaterial=function(t){var e=document.querySelector("#vertex-shader").textContent,i=this.getFragmentShader(t);return new THREE.RawShaderMaterial({uniforms:{textures:{type:"tv",value:t.textures},lodTexture:{type:"t",value:lod.tex.texture},transitionPercent:{type:"f",value:0},scale:{type:"f",value:this.getPointScale()},targetScale:{type:"f",value:this.getPointScale()},useColor:{type:"f",value:t.useColor?1:0},cellAtlasPxPerSide:{type:"f",value:config.size.texture},lodAtlasPxPerSide:{type:"f",value:config.size.lodTexture},cellPxHeight:{type:"f",value:config.size.cell},lodPxHeight:{type:"f",value:config.size.lodCell},borderWidth:{type:"f",value:.15},selectedBorderColor:{type:"vec3",value:new Float32Array([234/255,183/255,85/255])},clusterBorderColor:{type:"vec3",value:new Float32Array([1,1,1])},display:{type:"f",value:1},time:{type:"f",value:0}},vertexShader:e,fragmentShader:i})},World.prototype.setUniform=function(t,e){for(var i=this.group.children.concat(picker.scene.children[0].children),o=0;o<i.length;o++)i[o].material.uniforms[t].value=e},World.prototype.setBuffer=function(t,e){var i=world.getDrawCallToCells();for(var o in i){var s=world.group.children[o].geometry.attributes[t],n=i[o];s.array=e.slice(n[0].idx,n[n.length-1].idx+1),s.needsUpdate=!0}},World.prototype.setBorderedImages=function(t){for(var e=new Uint8Array(data.cells.length),i=0;i<t.length;i++)e[t[i]]=1;this.setBuffer("selected",e)},World.prototype.setOpaqueImages=function(t){for(var e=new Float32Array(data.cells.length),i=0;i<e.length;i++)e[i]=.35;for(i=0;i<t.length;i++)e[t[i]]=1;this.setBuffer("opacity",e)},World.prototype.setBorderColorImages=function(t,e){for(var i=new Float32Array(3*data.cells.length),o=0;o<t.length;o++){var s=e[o];r=s[0],g=s[1],b=s[2],idx=3*o,i[idx]=r,i[idx+1]=g,i[idx+2]=b}key="labelBorderColor";var n=world.getDrawCallToCells();for(var o in n){var a=world.group.children[o].geometry.attributes[key];n[o];a.array=i,a.needsUpdate=!0}},World.prototype.getFragmentShader=function(t){var e=t.useColor,i=t.firstTex,o=t.textures,s=document.querySelector("#fragment-shader").textContent;if(e)return s=(s=s.replace("uniform sampler2D textures[N_TEXTURES];","")).replace("TEXTURE_LOOKUP_TREE","");for(var n=this.getFragLeaf(-1,"lodTexture"),a=i;a<i+o.length;a++)n+=" else "+this.getFragLeaf(a,"textures["+a+"]");return s=(s=(s=s.replace("#define SELECTING\n","")).replace("N_TEXTURES",o.length)).replace("TEXTURE_LOOKUP_TREE",n)},World.prototype.getFragLeaf=function(t,e){return"if (textureIndex == "+t+") {\n          gl_FragColor = texture2D("+e+", uv);\n        }"},World.prototype.attrsNeedUpdate=function(t){this.group.children.forEach(function(e){t.forEach(function(t){e.geometry.attributes[t].needsUpdate=!0}.bind(this))}.bind(this))},World.prototype.getStats=function(){if(!window.location.href.includes("stats=true"))return null;var t=new Stats;return t.domElement.id="stats",t.domElement.style.position="absolute",t.domElement.style.top="65px",t.domElement.style.right="5px",t.domElement.style.left="initial",document.body.appendChild(t.domElement),t},World.prototype.flyTo=function(t){if(!this.state.flying){this.state.flying=!0;var e=this.getCamera(),i=new THREE.TrackballControls(e,this.canvas);e.position.set(t.x,t.y,t.z),"trackball"===this.controls.type&&(i.target.set(t.x,t.y,t.z-1e-6),i.update());var o=0,s=this.camera.quaternion.clone();TweenLite.to(this.camera.position,config.transitions.duration,{x:t.x,y:t.y,z:t.z,onUpdate:function(){var t=++o/(60*config.transitions.duration);THREE.Quaternion.slerp(s,e.quaternion,this.camera.quaternion,t)}.bind(this),onComplete:function(){var t=e.quaternion,o=e.position,s=e.up,n=i.target,a=getMinCellZ();this.camera.position.set(o.x,o.y,o.z),this.camera.up.set(s.x,s.y,s.z),this.camera.quaternion.set(t.x,t.y,t.z,t.w),"trackball"==this.controls.type&&(this.controls.target=new THREE.Vector3(n.x,n.y,a),this.controls.update()),this.state.flying=!1}.bind(this),ease:t.ease||Power4.easeInOut})}},World.prototype.flyToCellIdx=function(t){var e=data.cells[t];world.flyTo({x:e.x,y:e.y,z:Math.min(config.pickerMaxZ-1e-4,e.z+this.getPointScale()/100)})},World.prototype.flyToCellImage=function(t){for(var e=null,i=0;i<data.json.images.length;i++)data.json.images[i]==t&&(e=i);if(!e)return console.warn("The requested image could not be found");data.cells[e];this.flyToCellIdx(e)},World.prototype.getInitialLocation=function(){return{x:0,y:0,z:2}},World.prototype.render=function(){requestAnimationFrame(this.render.bind(this)),this.state.displayed&&(this.renderer.render(this.scene,this.camera),"trackball"===this.controls.type?this.controls.update():"fly"===this.controls.type&&this.controls.update(this.clock.getDelta()),this.stats&&this.stats.update(),lod.update(),lasso.update())},World.prototype.init=function(){this.setCenter();var t=this.getInitialLocation();this.camera.position.set(t.x,t.y,t.z),this.camera.lookAt(t.x,t.y,t.z),"trackball"===this.controls.type&&(this.controls.target.z=getMinCellZ(),this.controls.update()),this.plotPoints(),this.handleResize(),this.render(),this.setMode("pan"),world.state.displayed=!0,this.addDeviceInteractionGuide()},World.prototype.handleModeIconClick=function(t){this.setMode(t.target.id),data.hotspots.setCreateHotspotVisibility(!1)},World.prototype.handleKeyDown=function(t){32==t.keyCode&&(this.state.togglingMode||(this.state.togglingMode=!0,this.toggleMode()))},World.prototype.handleKeyUp=function(t){32==t.keyCode&&(this.state.togglingMode=!1,this.toggleMode())},World.prototype.toggleMode=function(){this.setMode("pan"===this.mode?"select":"pan")},World.prototype.showSelectTooltip=function(){localStorage.getItem("select-tooltip-cleared")&&"false"!=localStorage.getItem("select-tooltip-cleared")||(this.elems.selectTooltip.style.display="inline-block"),this.elems.selectTooltipButton.addEventListener("click",function(){this.hideSelectTooltip()}.bind(this))},World.prototype.hideSelectTooltip=function(){localStorage.setItem("select-tooltip-cleared",!0),this.elems.selectTooltip.style.display="none"},World.prototype.setMode=function(t){this.mode=t;for(var e=document.querySelectorAll("#selection-icons img"),i=0;i<e.length;i++)e[i].className=e[i].id==t?"active":"";"pan"==this.mode?(this.controls.noPan=!1,this.canvas.classList.remove("select"),this.canvas.classList.add("pan"),lasso.removeMesh(),lasso.setFrozen(!0),lasso.setEnabled(!1)):"select"==this.mode&&(this.controls.noPan=!0,this.canvas.classList.remove("pan"),this.canvas.classList.add("select"),lasso.setEnabled(!0))},World.prototype.addDeviceInteractionGuide=function(){if(config.isTouchDevice){var t=this.elems.mobileInteractions;t.querySelector("button").addEventListener("click",function(){t.style.display="none"}.bind(this))}},Lasso.prototype.addMouseEventListeners=function(){window.addEventListener("mousedown",this.handleMouseDown.bind(this)),window.addEventListener("touchstart",this.handleMouseDown.bind(this)),window.addEventListener("mousemove",this.handleMouseMove.bind(this)),window.addEventListener("touchmove",this.handleMouseMove.bind(this)),window.addEventListener("mouseup",this.handleMouseUp.bind(this)),window.addEventListener("touchend",this.handleMouseUp.bind(this))},Lasso.prototype.isLassoEvent=function(t){return t.target.id&&"pixplot-canvas"===t.target.id},Lasso.prototype.handleMouseDown=function(t){this.enabled&&this.isLassoEvent(t)&&(keyboard.shiftPressed()||keyboard.commandPressed()||(this.points=[]),this.mousedownCoords=getEventClientCoords(t),this.setCapturing(!0),this.setFrozen(!1))},Lasso.prototype.handleMouseMove=function(t){this.capturing&&!this.frozen&&this.isLassoEvent(t)&&(this.points.push(getEventWorldCoords(t)),this.draw())},Lasso.prototype.handleMouseUp=function(t){if(this.enabled){this.setFrozen(!0);var e=getEventClientCoords(t);e.x!=this.mousedownCoords.x||e.y!=this.mousedownCoords.y||keyboard.shiftPressed()||keyboard.commandPressed()||this.clear(),t.target.id&&"select"!=t.target.id&&this.setCapturing(!1)}},Lasso.prototype.addModalEventListeners=function(){this.elems.modalContainer.addEventListener("click",function(t){if("modal-top"==t.target.className&&(this.elems.modalContainer.style.display="none",this.displayed=!1),"background-image"==t.target.className){var e=[],i=0;Object.keys(this.selected).forEach(function(o,s){o===t.target.getAttribute("data-image")&&(i=e.length),this.selected[o]&&e.push(s)}.bind(this)),modal.showCells(e,i)}}.bind(this)),this.elems.viewSelected.addEventListener("click",function(){var t=Object.keys(this.selected).filter(function(t){return this.selected[t]}.bind(this)),e=_.template(this.elems.modalTemplate.textContent);this.elems.modalTarget.innerHTML=e({images:t}),this.elems.modalContainer.style.display="block",this.displayed=!0}.bind(this)),this.elems.modalContainer.addEventListener("click",function(t){if(t.target.className.includes("toggle-selection")){t.preventDefault();var e=t.target.parentNode.querySelector(".background-image"),i=e.getAttribute("data-image");e.classList.toggle("unselected");for(var o=0;o<data.json.images.length;o++)if(data.json.images[o]==i){this.toggleSelection(o);break}}}.bind(this));for(var t=0;t<this.elems.filetypeButtons.length;t++)this.elems.filetypeButtons[t].addEventListener("click",function(t){for(var e=0;e<this.elems.filetypeButtons.length;e++)this.elems.filetypeButtons[e].classList.remove("active");t.target.classList.add("active"),this.downloadFiletype=t.target.id}.bind(this));this.elems.downloadLink.addEventListener("click",this.downloadSelected.bind(this)),this.elems.xIcon.addEventListener("click",this.clear.bind(this))},Lasso.prototype.update=function(){this.enabled&&this.mesh&&(this.time+=this.clock.getDelta()/10,this.mesh.material.uniforms.time.value=this.time)},Lasso.prototype.setEnabled=function(t){this.enabled=t},Lasso.prototype.setCapturing=function(t){this.capturing=t},Lasso.prototype.setFrozen=function(t){this.frozen=t},Lasso.prototype.clear=function(){world.setBorderedImages([]),this.removeMesh(),this.elems.viewSelectedContainer.style.display="none",data.hotspots.setCreateHotspotVisibility(!1),this.setCapturing(!1),this.points=[]},Lasso.prototype.removeMesh=function(){this.mesh&&world.scene.remove(this.mesh)},Lasso.prototype.draw=function(){this.points.length<4||(this.points=this.getHull(),this.removeMesh(),this.selected=this.getSelectedMap(),this.highlightSelected(),this.mesh=this.getMesh(),world.scene.add(this.mesh))},Lasso.prototype.getMesh=function(){for(var t=[],e=0;e<this.points.length;e++){var i=this.points[e];t.push(new THREE.Vector3(i.x,i.y,0))}t.push(t[0]);var o=getCumulativeLengths(t),s=(new THREE.BufferGeometry).setFromPoints(t),n=new THREE.BufferAttribute(new Float32Array(o),1);s.setAttribute("length",n);var a=new THREE.RawShaderMaterial({uniforms:{time:{type:"float",value:0},render:{type:"bool",value:!0}},vertexShader:document.querySelector("#dashed-vertex-shader").textContent,fragmentShader:document.querySelector("#dashed-fragment-shader").textContent}),r=new THREE.Line(s,a);return r.frustumCulled=!1,r},Lasso.prototype.getHull=function(){for(var t=new ConvexHullGrahamScan,e=0;e<this.points.length;e++)t.addPoint(this.points[e].x,this.points[e].y);return t.getHull()},Lasso.prototype.getSelectedMetadata=function(t){var e=this.getSelectedFilenames(),i=[];if(data.json.metadata)for(var o=0;o<e.length;o++){var s={};get(config.data.dir+"/metadata/file/"+e[o]+".json",function(o){if(s[o.filename]=o,Object.keys(s).length==e.length){for(var n=Object.keys(s),a=0;a<n.length;a++){var r=s[n[a]];i.push([r.filename||"",(r.tags||[]).join("|"),r.description,r.permalink])}t(i)}}.bind(this))}else{for(o=0;o<e.length;o++)i.push([e[o]]);t(i)}},Lasso.prototype.downloadSelected=function(){var t=this.downloadFiletype,e=this.elems.downloadInput.value||Date.now().toString();e.endsWith("."+t)||(e+="."+t),this.getSelectedMetadata(function(i){if("csv"==t||"json"==t)downloadFile(i,e);else if("zip"==t){var o=new JSZip;o.file("metadata.csv",Papa.unparse(i));for(var s=o.folder("images"),n=this.getSelectedFilenames(),a=0,r=0;r<n.length;r++){imageToDataUrl(getPath("data/originals/"+n[r]),function(t){var i=t.src.split("originals/")[1],r=t.dataUrl.split(";base64,")[1];s.file(i,r,{base64:!0}),++a==n.length&&o.generateAsync({type:"blob"}).then(function(t){downloadBlob(t,e)})})}}}.bind(this))},Lasso.prototype.getSelectedFilenames=function(){return Object.keys(this.selected).filter(function(t){return this.selected[t]}.bind(this))},Lasso.prototype.getSelectedMap=function(){for(var t=this.points.map(function(t){return[t.x,t.y]}),e={},i=0;i<data.json.images.length;i++){var o=[data.cells[i].x,data.cells[i].y];e[data.json.images[i]]=pointInPolygon(o,t)}return e},Lasso.prototype.highlightSelected=function(){for(var t=[],e=Object.keys(this.selected),i=0;i<e.length;i++)this.selected[e[i]]&&t.push(i);t.length&&(world.hideSelectTooltip(),this.elems.viewSelectedContainer.style.display="block",this.elems.countTarget.textContent=t.length,data.hotspots.setCreateHotspotVisibility(!0)),this.setNSelected(t.length),world.setBorderedImages(t)},Lasso.prototype.toggleSelection=function(t){var e=data.json.images[t];this.selected[e]=!this.selected[e],this.highlightSelected()},Lasso.prototype.setNSelected=function(t){var e=document.querySelector("#n-images-selected");if(e){if(!Number.isInteger(t)){t=0;for(var i=Object.keys(this.selected),o=0;o<i.length;o++)this.selected[i[o]]&&t++}e.textContent=t,this.elems.countTarget.textContent=t}},ConvexHullGrahamScan.prototype={constructor:ConvexHullGrahamScan,Point:function(t,e){this.x=t,this.y=e},_findPolarAngle:function(t,e){var i,o,s=57.295779513082;if(!t||!e)return 0;if(i=e.x-t.x,o=e.y-t.y,0==i&&0==o)return 0;var n=Math.atan2(o,i)*s;return this.reverse?n<=0&&(n+=360):n>=0&&(n+=360),n},addPoint:function(t,e){this.anchorPoint===undefined||this.anchorPoint.y>e||this.anchorPoint.y===e&&this.anchorPoint.x>t?(this.anchorPoint!==undefined&&this.points.push(new this.Point(this.anchorPoint.x,this.anchorPoint.y)),this.anchorPoint=new this.Point(t,e)):this.points.push(new this.Point(t,e))},_sortPoints:function(){var t=this;return this.points.sort(function(e,i){var o=t._findPolarAngle(t.anchorPoint,e),s=t._findPolarAngle(t.anchorPoint,i);return o<s?-1:o>s?1:0})},_checkPoints:function(t,e,i){var o=this._findPolarAngle(t,e),s=this._findPolarAngle(t,i);return o>s?!(o-s>180):!(o<s)||s-o>180},getHull:function(){var t,e,i=[];if(this.reverse=this.points.every(function(t){return t.x<0&&t.y<0}),(e=(t=this._sortPoints()).length)<3)return t.unshift(this.anchorPoint),t;for(i.push(t.shift(),t.shift());;){var o,s,n;if(i.push(t.shift()),o=i[i.length-3],s=i[i.length-2],n=i[i.length-1],this._checkPoints(o,s,n)&&i.splice(i.length-2,1),0==t.length){if(e==i.length){var a=this.anchorPoint;return(i=i.filter(function(t){return!!t})).some(function(t){return t.x==a.x&&t.y==a.y})||i.unshift(this.anchorPoint),i}e=(t=i).length,(i=[]).push(t.shift(),t.shift())}}}},Picker.prototype.getTexture=function(){var t=getCanvasSize(),e=new THREE.WebGLRenderTarget(t.w,t.h);return e.texture.minFilter=THREE.LinearFilter,e},Picker.prototype.onMouseDown=function(t){var e=this.getClickOffsets(t);this.mouseDown.x=e.x,this.mouseDown.y=e.y},Picker.prototype.onMouseUp=function(t){if("modal-top"==t.target.className||"modal-x"==t.target.className)return t.stopPropagation(),modal.close();var e=this.getClickOffsets(t),i=this.select({x:e.x,y:e.y});if(-1!==i&&"pixplot-canvas"===t.target.id){var o=config.isTouchDevice?10:0;if(!(Math.abs(e.x-this.mouseDown.x)>o||Math.abs(e.y-this.mouseDown.y)>o)){if("select"==world.mode&&(keyboard.shiftPressed()||keyboard.commandPressed()))return lasso.toggleSelection(i);if("pan"===world.mode)return world.camera.position.z>config.pickerMaxZ?world.flyToCellIdx(i):modal.showCells([i])}}},Picker.prototype.getClickOffsets=function(t){for(var e=t.target,i=getEventClientCoords(t);e.offsetParent;)i.x-=e.offsetLeft-e.scrollLeft,i.y-=e.offsetTop-e.scrollTop,e=e.offsetParent;return i},Picker.prototype.init=function(){world.canvas.addEventListener("mousedown",this.onMouseDown.bind(this)),world.canvas.addEventListener("touchstart",this.onMouseDown.bind(this),{passive:!1}),document.body.addEventListener("mouseup",this.onMouseUp.bind(this)),document.body.addEventListener("touchend",this.onMouseUp.bind(this),{passive:!1});for(var t=new THREE.Group,e=0;e<world.group.children.length;e++){var i=world.group.children[e].clone();i.material=world.getShaderMaterial({useColor:!0}),t.add(i)}this.scene.add(t)},Picker.prototype.render=function(){world.renderer.setRenderTarget(this.tex),world.renderer.render(this.scene,world.camera),world.renderer.setRenderTarget(null)},Picker.prototype.select=function(t){if(world&&t){this.render();var e=new Uint8Array(4),i=t.x*window.devicePixelRatio,o=this.tex.height-t.y*window.devicePixelRatio;return world.renderer.readRenderTargetPixels(this.tex,i,o,1,1,e),(e[0]<<16|e[1]<<8|e[2])-1}},Dates.prototype.init=function(){this.elems={container:document.querySelector("#date-container"),slider:document.querySelector("#date-slider")},data.json.layouts.date&&(this.elems.container.style.display="inline-block",this.state={data:{},min:null,max:null,selected:[null,null]},filters.filters.push(this),this.imageSelected=function(){return!0},this.load())},Dates.prototype.load=function(){get(getPath(config.data.dir+"/metadata/dates.json"),function(t){this.state.min=t.domain.min,this.state.max=t.domain.max,Object.keys(t.dates).forEach(function(e){try{var i=parseInt(e)}catch(o){i=e}t.dates[e].forEach(function(t){this.state.data[t]=i}.bind(this)),this.imageSelected=function(t){var e=this.state.data[t];return this.state.selected[0]==this.state.min&&this.state.selected[1]==this.state.max||!(!e||!Number.isInteger(e))&&(e>=this.state.selected[0]&&e<=this.state.selected[1])}}.bind(this)),this.addFilter()}.bind(this))},Dates.prototype.addFilter=function(){this.slider=noUiSlider.create(this.elems.slider,{start:[this.state.min,this.state.max],tooltips:[!0,!0],step:1,behaviour:"drag",connect:!0,range:{min:this.state.min,max:this.state.max},format:{to:function(t){return parseInt(t)},from:function(t){return parseInt(t)}}}),this.slider.on("update",function(t){this.state.selected=t,filters.filterImages()}.bind(this))},Text.prototype.init=function(){data.json.layouts.date&&(this.count=1e3,this.point=128,this.scale=0,this.kerning=0,this.canvas=null,this.texture=this.getTexture(),this.json={},this.createMesh(),this.addEventListeners())},Text.prototype.addEventListeners=function(){window.addEventListener("resize",function(){this.mesh&&(this.mesh.material.uniforms.scale.value=world.getPointScale())}.bind(this))},Text.prototype.getTexture=function(){var t=document.createElement("canvas"),e=t.getContext("2d"),i={},o=.2,s=.2,n=48,a=122,r=":;<=>?@[\\]^_`",l=a-n-r.length+1;this.canvas=this.point*Math.ceil(l**.5),t.width=this.canvas,t.height=this.canvas,t.id="character-canvas",e.font=this.point+"px Monospace",e.fillStyle="#000000",e.fillRect(0,0,t.width,t.height),e.fillStyle="#ffffff";for(var d=0,h=0,c=n;c<a+1;c++){var u=String.fromCharCode(c);r.includes(u)||(i[u]={x:d,y:h},e.fillText(u,d+o*this.point,h+this.point-s*this.point),(d+=this.point)>t.width-this.point&&(d=0,h+=this.point))}var p=new THREE.Texture(t);return p.flipY=!1,p.needsUpdate=!0,{map:i,tex:p}},Text.prototype.createMesh=function(){this.scale=config.size.points.date,this.kerning=.8*this.scale;var t=new THREE.BufferGeometry,e=new THREE.BufferAttribute(new Float32Array(3*this.count),3),i=new THREE.BufferAttribute(new Uint16Array(2*this.count),2);t.setAttribute("position",e),t.setAttribute("offset",i);var o=new THREE.RawShaderMaterial({uniforms:{point:{type:"f",value:this.point},canvas:{type:"f",value:this.canvas},scale:{type:"f",value:this.getPointScale()},texture:{type:"t",value:this.texture.tex},render:{type:"f",value:0}},vertexShader:document.querySelector("#text-vertex-shader").textContent,fragmentShader:document.querySelector("#text-fragment-shader").textContent});this.mesh=new THREE.Points(t,o),this.mesh.frustumCulled=!1,world.scene.add(this.mesh)},Text.prototype.setWords=function(t){var e=new Uint16Array(2*this.count),i=new Float32Array(3*this.count),o=0,s=0;t.forEach(function(t){for(var n=0;n<t.word.length;n++){var a=t.word[n]in this.texture.map?this.texture.map[t.word[n]]:{x:this.canvas-this.point,y:this.canvas-this.point};e[o++]=a.x,e[o++]=a.y,i[s++]=t.x+this.kerning*n,i[s++]=t.y,i[s++]=t.z||0}this.mesh.geometry.attributes.position.array=i,this.mesh.geometry.attributes.offset.array=e,this.mesh.geometry.attributes.position.needsUpdate=!0,this.mesh.geometry.attributes.offset.needsUpdate=!0}.bind(this))},Text.prototype.getPointScale=function(){return window.devicePixelRatio*window.innerHeight*this.scale},Text.prototype.formatText=function(t){var e=[];t.labels.forEach(function(i,o){e.push({word:i,x:t.positions[o][0],y:t.positions[o][1]})}),this.setWords(e)},Modal.prototype.showCells=function(t,e){function i(t){t=t||{};var e=document.querySelector("#selected-image-template").textContent,i=document.querySelector("#selected-image-modal"),a={multiImage:o.cellIndices.length>1,meta:Object.assign({},t||{},{src:n,filename:t.filename||s,labels:imageLabels.idToLabel})};i.innerHTML=_.template(e)(a),i.style.display="block",document.querySelector("#selected-image-target").appendChild(t.image),document.querySelector("#selected-image-modal .modal-top").style.opacity=1,s&&o.setLabel(s);var r=document.querySelector("#save-labels");r&&r.addEventListener("click",o.handleSaveLabel.bind(this))}var o=this;settings.close(),o.state.displayed=!0,o.cellIndices=Object.assign([],t),o.cellIdx=isNaN(parseInt(e))?0:parseInt(e);var s=data.json.images[o.cellIndices[o.cellIdx]],n=config.data.dir+"/originals/"+s,a=new Image;a.id="selected-image",a.onload=function(){i({image:a}),get(config.data.dir+"/metadata/file/"+s+".json",function(t){i(Object.assign({},t,{image:a}))})},a.src=n},Modal.prototype.setLabel=function(t){fl=imageLabels.filenameLabel[t],l=imageLabels.labelToId[fl];var e=document.querySelectorAll('input[name="label-option"]');for(let t=0;t<e.length;t++)radioButton=e[t],radioButton.id==l&&(radioButton.checked=!0)},Modal.prototype.handleSaveLabel=function(){var t=document.querySelectorAll('input[name="label-option"]');let e;for(let i=0;i<t.length;i++)if(radioButton=t[i],radioButton.checked){e=radioButton.value;break}var i=document.querySelector("#image-title").innerText;imageLabels.updateFilenameLabel(i,e),modal.close()},Modal.prototype.close=function(){document.querySelector("#selected-image-modal .modal-top")&&(this.fadeOutContent(),setTimeout(function(){document.querySelector("#selected-image-modal").style.display="none",this.cellIndices=[],this.cellIdx=null,this.state.displayed=!1}.bind(this),230))},Modal.prototype.fadeOutContent=function(){document.querySelector("#selected-image-modal .modal-top").style.opacity=0},Modal.prototype.addEventListeners=function(){var t=this;window.addEventListener("keydown",this.handleKeydown.bind(this));new Swipes({onSwipeRight:function(){t.state.displayed&&t.showPreviousCell()},onSwipeLeft:function(){t.state.displayed&&t.showNextCell()}})},Modal.prototype.handleKeydown=function(t){37==t.keyCode&&this.showPreviousCell(),39==t.keyCode&&this.showNextCell()},Modal.prototype.showPreviousCell=function(){if(this.state.displayed){var t=this.cellIdx>0?this.cellIdx-1:this.cellIndices.length-1;this.fadeOutContent(),setTimeout(function(){this.showCells(this.cellIndices,t)}.bind(this),250)}},Modal.prototype.showNextCell=function(){if(this.state.displayed){var t=this.cellIdx<this.cellIndices.length-1?this.cellIdx+1:0;this.fadeOutContent(),setTimeout(function(){this.showCells(this.cellIndices,t)}.bind(this),250)}},LOD.prototype.getCanvas=function(t){var e=getElem("canvas",{width:t,height:t,id:"lod-canvas"});return{canvas:e,ctx:e.getContext("2d"),texture:world.getTexture(e)}},LOD.prototype.getAllTexCoords=function(){for(var t=[],e=0;e<config.size.lodTexture/config.size.lodCell;e++)for(var i=0;i<config.size.lodTexture/config.size.lodCell;i++)t.push({x:i*config.size.lodCell,y:e*config.size.lodCell});return t},LOD.prototype.indexCells=function(){var t={};data.cells.forEach(function(e){e.gridCoords=this.toGridCoords(e);var i=e.gridCoords.x,o=e.gridCoords.y;t[i]||(t[i]={}),t[i][o]||(t[i][o]=[]),t[i][o].push(e.idx)}.bind(this)),this.grid=t},LOD.prototype.toGridCoords=function(t){var e=data.boundingBox,i={x:(t.x-e.x.min)/(e.x.max-e.x.min),y:(t.y-e.y.min)/(e.y.max-e.y.min)},o={x:1/Math.max(100,Math.ceil(data.json.images.length/100)),y:1/Math.max(100,Math.ceil(data.json.images.length/100))};return{x:Math.floor(i.x/o.x),y:Math.floor(i.y/o.y)}},LOD.prototype.update=function(){!this.state.run||world.state.flying||world.state.transitioning||(this.updateGridPosition(),this.fetchNextImage(),world.camera.position.z<this.minZ?this.addCellsToLodTexture():this.clear())},LOD.prototype.updateGridPosition=function(){var t=this.toGridCoords(world.camera.position);this.state.camPos.x===t.x&&this.state.camPos.y===t.y||(this.state.radius>1&&(this.state.radius=Math.ceil(.6*this.state.radius)),this.state.camPos=t,this.state.neighborsRequested=0,this.unload(),world.camera.position.z<this.minZ&&(this.state.fetchQueue=getNested(this.grid,[t.x,t.y],[])))},LOD.prototype.fetchNextImage=function(){if(!lasso.displayed){var t=this.state.fetchQueue[0];if(this.state.fetchQueue=this.state.fetchQueue.slice(1),Number.isInteger(t))if(this.cellIdxToImage[t])this.state.cellIdxToCoords[t]||(this.state.cellsToActivate=this.state.cellsToActivate.concat(t));else{var e=new Image;e.onload=function(t){this.cellIdxToImage[t]=e,this.state.cellIdxToCoords[t]||(this.state.cellsToActivate=this.state.cellsToActivate.concat(t))}.bind(this,t),e.src=config.data.dir+"/thumbs/"+data.json.images[t]}else if(this.state.neighborsRequested<this.state.radius){this.state.neighborsRequested=this.state.radius;for(var i=Math.floor(1.5*-this.state.radius);i<=Math.ceil(1.5*this.state.radius);i++)for(var o=-this.state.radius;o<=this.state.radius;o++){var s=[this.state.camPos.x+i,this.state.camPos.y+o],n=getNested(this.grid,s,[]).filter(function(t){return!this.state.cellIdxToCoords[t]}.bind(this));this.state.fetchQueue=this.state.fetchQueue.concat(n)}this.state.openCoords&&this.state.radius<30&&this.state.radius++}}},LOD.prototype.addCellsToLodTexture=function(){for(var t=!1,e=0;e<this.state.cellsToActivate.length;e++){var i=this.state.cellsToActivate[0],o=data.cells[i];if(this.state.cellsToActivate=this.state.cellsToActivate.slice(1),!this.state.cellIdxToCoords[i]&&this.inRadius(o.gridCoords)){var s=this.state.openCoords[0];if(this.state.openCoords=this.state.openCoords.slice(1),s){t=!0;var n=o.gridCoords.x+"."+o.gridCoords.y;this.state.gridPosToCoords[n]||(this.state.gridPosToCoords[n]=[]),this.state.gridPosToCoords[n].push(Object.assign({},s,{cellIdx:o.idx})),this.state.cellIdxToCoords[o.idx]=s,this.cell.ctx.clearRect(0,0,config.size.lodCell,config.size.lodCell),this.cell.ctx.drawImage(this.cellIdxToImage[o.idx],0,0);var a=world.getTexture(this.cell.canvas);world.renderer.copyTextureToTexture(s,a,this.tex.texture),o.activate()}}}t&&world.attrsNeedUpdate(["textureIndex","offset"])},LOD.prototype.inRadius=function(t){var e=Math.floor(Math.abs(t.x-this.state.camPos.x)),i=Math.ceil(Math.abs(t.y-this.state.camPos.y));return e<=1.5*this.state.radius&&i<this.state.radius},LOD.prototype.unload=function(){Object.keys(this.state.gridPosToCoords).forEach(function(t){var e=t.split(".");this.inRadius({x:parseInt(e[0]),y:parseInt(e[1])})||this.unloadGridPos(t)}.bind(this))},LOD.prototype.unloadGridPos=function(t){var e=this.state.gridPosToCoords[t];e.forEach(function(t){try{data.cells[t.cellIdx].deactivate(),delete this.state.cellIdxToCoords[t.cellIdx]}catch(e){}}.bind(this)),delete this.state.gridPosToCoords[t],
this.state.openCoords=this.state.openCoords.concat(e)},LOD.prototype.clear=function(){Object.keys(this.state.gridPosToCoords).forEach(this.unloadGridPos.bind(this)),this.state.camPos={x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},world.attrsNeedUpdate(["offset","textureIndex"]),this.state.radius=this.initialRadius},Labels.prototype.init=function(){this.createLegend(),this.updateLabels()},Labels.prototype.loadLabels=function(){get(getPath(config.data.dir+"/metadata/labels/id_to_label.json"),this.handleJson.bind(this)),get(getPath(config.data.dir+"/metadata/labels/id_to_color.json"),this.handleColor.bind(this)),get(getPath(config.data.dir+"/metadata/labels/filenames_label.json"),this.handleFileLabel.bind(this))},Labels.prototype.downloadUpdates=function(){for(var t in f="image_name, label, updated\r\n",this.filenameLabel){var e=t+","+this.filenameLabel[t]+",";t in this.userLabelUpdates?e+=" True":e+=" False",e+="\r\n",f+=e}var i="updated_labels.csv";this.download(i,f)},Labels.prototype.download=function(t,e){var i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),i.setAttribute("download",t),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)},Labels.prototype.createLegend=function(){var t=this.elems.legendContainer;for(var e in this.idToLabel){var i=this.idToLabel[e],o=this.labelColors[e],s=this.getHtmlColor(o),n=document.createElement("div");n.style="display: flex;";var a=document.createElement("div");a.style="align-items: center; width: 15px; height:15px; border-radius: 3px; border: 1px solid #717171; background-color: "+s;var r=document.createElement("div");r.style="display: inline-block; line-height: 20px;",r.innerText=i,n.appendChild(a),n.appendChild(r),t.appendChild(n)}},Labels.prototype.getHtmlColor=function(t){return"#"+(255*t[0]).toString(16).padStart(2,"0")+(255*t[1]).toString(16).padStart(2,"0")+(255*t[2]).toString(16).padStart(2,"0")},Labels.prototype.handleColor=function(t){this.labelColors=t},Labels.prototype.handleJson=function(t){for(var e in this.idToLabel=t,this.idToLabel)val=this.idToLabel[e],this.labelToId[val]=e},Labels.prototype.handleFileLabel=function(t){this.filenameLabel=t;var e=sessionStorage.getItem("labelChanges");e&&(this.userLabelUpdates=JSON.parse(e))},Labels.prototype.redrawBorders=function(){this.updateLabels()},Labels.prototype.updateFilenameLabel=function(t,e){newLabel=this.idToLabel[e],this.filenameLabel[t]!=newLabel&&(this.filenameLabel[t]=newLabel,this.userLabelUpdates[t]=newLabel,sessionStorage.setItem("labelChanges",JSON.stringify(this.userLabelUpdates)),this.redrawBorders())},Labels.prototype.updateLabels=function(){for(var t=[],e=[],i=0;i<data.json.images.length;i++){var o=data.json.images[i],s=this.filenameLabel[o],n=this.labelToId[s];t.push(i),e.push(this.labelColors[n])}world.setBorderColorImages(t,e)},Filters.prototype.loadFilters=function(){document.querySelector("#filters-mobile-container").style.display="block",get(getPath(config.data.dir+"/metadata/filters/filters.json"),function(t){for(var e=0;e<t.length;e++)this.filters.push(new Filter(t[e]))}.bind(this))},Filters.prototype.filterImages=function(){for(var t=[],e=0;e<data.json.images.length;e++){for(var i=!0,o=0;o<this.filters.length;o++)if(this.filters[o].imageSelected&&!this.filters[o].imageSelected(data.json.images[e])){i=!1;break}i&&t.push(e)}world.setOpaqueImages(t)},Filter.prototype.showHide=function(){this.desktopSelect.classList.toggle("open")},Filter.prototype.show=function(){this.desktopSelect.classList.add("open")},Filter.prototype.hide=function(){this.desktopSelect.classList.remove("open")},Filter.prototype.onChange=function(t,e){e.target;this.selected=this.getSelected(t,e),this.showSelected(),this.filterImages()},Filter.prototype.getSelected=function(t,e){if(!t)return e.target.value;for(var i=e.target;!i.classList.contains("filter-option");)i=i.parentNode;return i.classList.contains("active")?null:i.getAttribute("data-label")},Filter.prototype.showSelected=function(){for(var t=this.desktopSelect.querySelectorAll(".filter-option"),e=0;e<t.length;e++)t[e].getAttribute("data-label")==this.selected?(t[e].classList.add("active"),t[e].querySelector("input").checked=!0):(t[e].classList.remove("active"),t[e].querySelector("input").checked=!1);this.selected?this.desktopSelect.classList.add("has-selection"):this.desktopSelect.classList.remove("has-selection"),this.selected&&(this.mobileSelect.value=this.selected)},Filter.prototype.filterImages=function(){if(this.selected){var t=this.selected.replace(/\//g,"-").replace(/ /g,"__")+".json";get(getPath(config.data.dir+"/metadata/options/"+t),function(t){var e=t.reduce(function(t,e){return t[e]=!0,t},{});this.imageSelected=function(t){return t in e},filters.filterImages()}.bind(this))}else this.imageSelected=function(){return!0},filters.filterImages()},Settings.prototype.open=function(){this.state.open=!0,this.elems.tray.classList.add("open"),this.elems.icon.classList.add("no-tooltip"),this.elems.icon.classList.add("active"),tooltip.hide()},Settings.prototype.close=function(){this.state.open=!1,this.elems.tray.classList.remove("open"),this.elems.icon.classList.remove("no-tooltip"),this.elems.icon.classList.remove("active")},Settings.prototype.toggleOpen=function(){this.state.open?this.close():this.open()},Hotspots.prototype.initialize=function(){get(getPath(data.json.custom_hotspots),this.handleJson.bind(this),function(){get(getPath(data.json.default_hotspots),this.handleJson.bind(this))}.bind(this))},Hotspots.prototype.handleJson=function(t){0==t.length&&(this.elems.nav.style.display="none"),this.json=t,this.render()},Hotspots.prototype.addEventListeners=function(){this.elems.createHotspot.addEventListener("click",function(){for(var t=[],e=0;e<data.cells.length;e++)lasso.selected[data.json.images[e]]&&t.push(e);this.json.push({label:data.hotspots.getUserClusterName(),img:data.json.images[choose(t)],images:t,layout:layout.selected}),this.setCreateHotspotVisibility(!1),this.setEdited(!0),this.render(),setTimeout(this.scrollToBottom.bind(this),100)}.bind(this)),this.elems.saveHotspots.addEventListener("click",function(){downloadFile(this.json,"user_hotspots.json"),this.setEdited(!1)}.bind(this)),this.elems.navInner.addEventListener("dragover",function(t){t.preventDefault()}),this.elems.navInner.addEventListener("drop",function(t){for(var e=t.pageY,i=document.querySelectorAll(".hotspot"),o=t.dataTransfer.getData("text"),s=document.getElementById(o),n=!1,a=0;a<i.length;a++){var r=i[a],l=r.getBoundingClientRect();if(!n&&e<=l.top+l.height/2){s.classList.remove("dragging"),r.parentNode.insertBefore(s,r),n=!0;break}}n||this.elems.hotspots.appendChild(s);var d=parseInt(o.split("-")[1]),h=a;this.json.splice(h,0,this.json.splice(d,1)[0]),this.render(),d!=h&&this.setEdited(!0)}.bind(this)),this.elems.nav.addEventListener("mouseenter",function(){localStorage.getItem("hotspots-tooltip-cleared")||(this.elems.tooltip.style.display="block")}.bind(this)),this.elems.clearTooltip.addEventListener("click",function(){localStorage.setItem("hotspots-tooltip-cleared",!0),this.elems.tooltip.style.display="none"}.bind(this))},Hotspots.prototype.render=function(){this.mesh&&world.scene.remove(this.mesh),this.elems.hotspots.innerHTML=_.template(this.elems.template.innerHTML)({hotspots:this.json,isLocalhost:config.isLocalhost,edited:this.edited});for(var t=document.querySelectorAll(".hotspot"),e=0;e<t.length;e++){var i;t[e].querySelector(".hotspot-bar-inner").style.width=100*this.json[e].images.length/data.cells.length+"%",t[e].querySelector(".hotspot-image").addEventListener("click",function(t){world.flyToCellImage(this.json[t].img)}.bind(this,e)),t[e].addEventListener("mouseenter",function(t){this.setHotspotHoverBuffer(this.json[t].images)}.bind(this,e)),t[e].addEventListener("mouseleave",function(){this.setHotspotHoverBuffer([]),world.scene.remove(this.mesh)}.bind(this)),(i=t[e].querySelector(".remove-hotspot-x"))&&i.addEventListener("click",function(t,e){e.preventDefault(),e.stopPropagation(),this.json.splice(t,1),this.setEdited(!0),this.render()}.bind(this,e)),(i=t[e].querySelector(".refresh-hotspot"))&&i.addEventListener("click",function(t,e){e.preventDefault(),e.stopPropagation();var i=Math.floor(Math.random()*this.json[t].images.length);this.json[t].img=data.json.images[this.json[t].images[i]],this.setEdited(!0),this.render()}.bind(this,e)),t[e].querySelector(".hotspot-label").addEventListener("keydown",function(e,i){13==i.keyCode&&(i.stopPropagation(),i.preventDefault(),t[e].querySelector(".hotspot-label").blur())}.bind(this,e)),t[e].querySelector(".hotspot-label").addEventListener("input",function(e){this.setEdited(!0),this.json[e].label=this.formatLabel(t[e].querySelector(".hotspot-label").textContent)}.bind(this,e)),t[e].addEventListener("dragstart",function(t){for(var e=e=t.target,i=e.id||null;!i;)i=(e=e.parentNode).id;e.classList.add("dragging"),t.dataTransfer.setData("text",i)})}},Hotspots.prototype.formatLabel=function(t){return t.replace(/[\u00A0-\u9999<>\&]/g,function(t){return"&#"+t.charCodeAt(0)+";"})},Hotspots.prototype.setEdited=function(t){this.edited=t,this.elems.saveHotspots.style.display=t?"inline-block":"none"},Hotspots.prototype.showHide=function(){this.elems.nav.className=["umap"].indexOf(layout.selected)>-1?"":"disabled"},Hotspots.prototype.scrollToBottom=function(){this.elems.navInner.scrollTo({top:this.elems.navInner.scrollHeight,behavior:"smooth"})},Hotspots.prototype.getUserClusterName=function(){for(var t=[],e=0;e<data.hotspots.json.length;e++)t.push(data.hotspots.json[e].label);var i="ABCDEFGHIJKLMNOPQRSTUVWXYZ",o="Cluster "+i[this.nUserClusters++];for(this.nUserClusters.length>=i.length&&(this.nUserClusters=0);t.indexOf(o)>-1;){o="Cluster "+i[this.nUserClusters++];this.nUserClusters.length>=i.length&&(this.nUserClusters=0)}return o},Hotspots.prototype.setCreateHotspotVisibility=function(t){config.isLocalhost&&(this.elems.createHotspot.style.display=t?"inline-block":"none")},Hotspots.prototype.setSaveHotspotsVisibility=function(t){this.elems.saveHotspots.style.display=t?"inline-block":"none"},Hotspots.prototype.setHotspotHoverBuffer=function(t){for(var e=t.reduce(function(t,e){return t[e]=!0,t},{}),i=(t=new Uint8Array(data.cells.length),0);i<t.length;i++)t[i]=e[i]?1:0;world.setBuffer("clusterSelected",t)},Globe.prototype.load=function(){function t(t,i){if(i&&!(i.length<6)){var o=new THREE.Shape;o.moveTo(e.xScale(i[0][0]),e.yScale(i[0][1])),i.map(t=>{o.lineTo(e.xScale(t[0]),e.yScale(t[1]))}),o.lineTo(e.xScale(i[0][0]),e.yScale(i[0][1]));var s=new THREE.ShapeGeometry(o),n=new THREE.Mesh(s);t.merge(n.geometry,n.matrix)}}var e=this;this.xScale=d3.scaleLinear().domain([-180,180]).range([-1,1]),this.yScale=d3.scaleLinear().domain([-90,90]).range([-.5,.5]),get(getPath("assets/json/flat-continents.json"),function(i){i.forEach(t.bind(this,e.globeGeometry));var o=new THREE.MeshBasicMaterial({color:3355443,side:THREE.DoubleSide});e.globeMesh=new THREE.Mesh(e.globeGeometry,o)}),get(getPath("assets/json/geographic-features.json"),function(i){i.forEach(t.bind(this,e.featureGeometry));var o=new THREE.MeshBasicMaterial({color:2236962,side:THREE.DoubleSide});e.featureMesh=new THREE.Mesh(e.featureGeometry,o)})},Globe.prototype.show=function(){world.scene.add(this.globeMesh),this.featureMesh&&world.scene.add(this.featureMesh)},Globe.prototype.hide=function(){world.scene.remove(this.globeMesh),this.featureMesh&&world.scene.remove(this.featureMesh)},Webgl.prototype.getGl=function(){var t=getElem("canvas").getContext("webgl");return t||(document.querySelector("#webgl-not-available").style.display="block"),t},Webgl.prototype.getLimits=function(){var t=this.gl.getSupportedExtensions().reduce(function(t,e){return t[e]=!0,t},{}),e=65535;return["","MOZ_","WEBKIT_"].forEach(function(i){t[i+"OES_element_index_uint"]&&(e=2**32-1)}),{textureSize:Math.min(this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),8192),textureCount:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),vShaderTextures:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),indexedElements:e}},Keyboard.prototype.shiftPressed=function(){return this.pressed[16]},Keyboard.prototype.commandPressed=function(){return this.pressed[91]},Tooltip.prototype.hide=function(){this.elem.style.top="-10000px"},Welcome.prototype.onButtonClick=function(t){t.target.className.indexOf("active")>-1&&requestAnimationFrame(function(){this.removeLoader(function(){this.startWorld()}.bind(this))}.bind(this))},Welcome.prototype.removeLoader=function(t){for(var e=document.querySelectorAll(".block"),i=0;i<e.length;i++)setTimeout(function(i){e[i].style.animation="exit 300s",setTimeout(function(i){e[i].parentNode.removeChild(e[i]),i==e.length-1&&t()}.bind(this,i),1e3)}.bind(this,i),100*i);document.querySelector("#progress").style.opacity=0},Welcome.prototype.updateProgress=function(){var t=valueSum(data.textureProgress)/data.textureCount,e=(t=t.toString()).indexOf(".");e>-1&&(t=t.substring(0,e)),this.progressElem.textContent=t+"%",100==t&&data.loadedTextures==data.textureCount&&world.heightmap&&(this.buttonElem.className+=" active")},Welcome.prototype.startWorld=function(){requestAnimationFrame(function(){world.init(),picker.init(),text.init(),dates.init(),imageLabels.init(),setTimeout(function(){requestAnimationFrame(function(){document.querySelector("#loader-scene").classList+="hidden",document.querySelector("#header-controls").style.opacity=1})},1500)}.bind(this))},AttractMode.prototype.resetActiveTimer=function(){this.setActive(!1),clearTimeout(this.timeout),clearTimeout(this.activeTimer),this.disabled||(this.activeTimer=setTimeout(function(){this.setActive(!0)}.bind(this),this.delays.initialize))},AttractMode.prototype.setActive=function(t){0==t?this.active=!1:(this.active=!0,this.eventIndex=-3,this.nextEvent())},AttractMode.prototype.nextEvent=function(){if(this.active&&!this.disabled)if(-3===this.eventIndex){this.viewIndex=this.viewIndex+1<data.hotspots.json.length-1?this.viewIndex+1:0,this.hotspot=data.hotspots.json[this.viewIndex];var t=world.getInitialLocation();world.flyTo({x:t.x,y:t.y,z:t.z-.35}),this.timeout=setTimeout(function(){var t=layout.options.indexOf(layout.selected),e=t+1<layout.options.length?t+1:0;layout.set(layout.options[e]),this.eventIndex++,this.nextEvent()}.bind(this),this.delays.layoutChange)}else-2===this.eventIndex?this.timeout=setTimeout(function(){if(this.active&&!this.disabled){var t=0;data.json.images.forEach(function(e,i){e===this.hotspot.img&&(t=i)}.bind(this)),world.flyToCellIdx(t),this.eventIndex++,this.nextEvent()}}.bind(this),this.delays.clusterZoom):-1===this.eventIndex?this.timeout=setTimeout(function(){this.active&&!this.disabled&&(modal.showCells(this.hotspot.images),this.eventIndex++,this.nextEvent())}.bind(this),this.delays.beforeLightbox):this.eventIndex<this.nImages?this.timeout=setTimeout(function(){this.active&&!this.disabled&&(modal.showNextCell(),this.eventIndex++,this.nextEvent())}.bind(this),this.delays.betweenLightbox):this.eventIndex===this.nImages?(modal.close(),this.timeout=setTimeout(function(){this.active&&!this.disabled&&(modal.close(),this.eventIndex++,this.nextEvent())}.bind(this),this.delays.betweenLightbox)):this.eventIndex>this.nImages&&(this.eventIndex=-3,this.nextEvent())};var welcome=new Welcome,webgl=new Webgl,config=new Config,imageLabels=new Labels,filters=new Filters,picker=new Picker,modal=new Modal,keyboard=new Keyboard,lasso=new Lasso,layout=new Layout,world=new World,text=new Text,dates=new Dates,lod=new LOD,settings=new Settings,tooltip=new Tooltip,globe=new Globe,data=new Data,attractmode=new AttractMode;